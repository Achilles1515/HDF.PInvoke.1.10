version: '{build}'
clone_depth: 1

image:
- Ubuntu
- Visual Studio 2017

branches:
  only:
  - master
  - dev
  - native-CI

before_build:
- ps: "Get-ChildItem Env:"

build_script:
- ps: |
    git clone --branch hdf5-1_10_5 --depth 1 --quiet https://bitbucket.hdfgroup.org/scm/hdffv/hdf5.git

    New-Item -Path build -ItemType directory
    Set-Location -Path ./build

    Invoke-WebRequest -Uri https://github.com/madler/zlib/archive/v1.2.11.tar.gz -OutFile ZLib.tar.gz
    Invoke-WebRequest -Uri https://support.hdfgroup.org/ftp/lib-external/szip/2.1.1/src/szip-2.1.1.tar.gz -OutFile SZip.tar.gz

    $params = @"
    -DCMAKE_BUILD_TYPE:STRING=Release
    -DBUILD_SHARED_LIBS:BOOL=ON
    -DBUILD_TESTING:BOOL=OFF

    -DHDF5_BUILD_CPP_LIB:BOOL=OFF
    -DHDF5_BUILD_EXAMPLES:BOOL=OFF
    -DHDF5_BUILD_FORTRAN:BOOL=OFF
    -DHDF5_BUILD_GENERATORS:BOOL=OFF
    -DHDF5_BUILD_HL_LIB:BOOL=OFF
    -DHDF5_BUILD_JAVA:BOOL=OFF
    -DHDF5_BUILD_TOOLS:BOOL=OFF
    -DHDF5_ENABLE_THREADSAFE:BOOL=ON

    -DCMAKE_POSITION_INDEPENDENT_CODE:BOOL=true
    -DHDF5_ALLOW_EXTERNAL_SUPPORT:STRING=TGZ
    -DHDF5_ENABLE_Z_LIB_SUPPORT:BOOL=ON
    -DHDF5_ENABLE_SZIP_SUPPORT:BOOL=ON
    -DHDF5_ENABLE_SZIP_ENCODING:BOOL=ON
    -DZLIB_TGZ_NAME:STRING=ZLib.tar.gz
    -DSZIP_TGZ_NAME:STRING=SZip.tar.gz
    -DTGZPATH:PATH=$((Get-Location).Path)
    "@.replace("`n"," ")

    if ($isLinux)
    { 
      Invoke-Expression "cmake -G 'Unix Makefiles' $params ./../hdf5"
    }
    elseif ($isWindows)
    {
      Invoke-Expression "cmake -G 'Visual Studio 15 2017 Win64' $params ./../hdf5"
    }

    cmake --build . --config Release

    if ($isLinux)
    {
      Set-Location -Path ./bin
      7z a -tzip ./../../artifacts.zip ./*.so*
    }
    elseif ($isWindows)
    {
      Set-Location -Path ./bin/release
      7z a -tzip ./../../../artifacts.zip ./*.dll
    }

artifacts:
  - path: "artifacts.zip"